name: CI

on:
  push:
    branches: ["*"]
    paths-ignore:
      - '.ci/**'
  pull_request:
    branches: ["main", "master"]
    paths-ignore:
      - '.ci/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer
  IOS_SIMULATOR_DEVICE: "iPhone 15"
  IOS_SIMULATOR_OS: "17.5"

jobs:
  build:
    name: Build
    runs-on: macos-14
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create log directory
        run: mkdir -p ci-logs

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Validate Xcode project file
        continue-on-error: true
        run: |
          set -o pipefail
          {
            echo "=== Validating Xcode project file ==="
            echo "File: HomeCooked/HomeCooked.xcodeproj/project.pbxproj"
            echo "Size: $(wc -c < HomeCooked/HomeCooked.xcodeproj/project.pbxproj) bytes"
            echo "Lines: $(wc -l < HomeCooked/HomeCooked.xcodeproj/project.pbxproj)"

            # Check for mixed tabs/spaces (common parse error cause)
            TAB_COUNT=$(grep -cP '^\t' HomeCooked/HomeCooked.xcodeproj/project.pbxproj || echo "0")
            echo "Lines starting with tabs: $TAB_COUNT"
            if [ "$TAB_COUNT" -gt 0 ]; then
              echo "⚠️  WARNING: Found $TAB_COUNT lines with tab indentation (may cause parse errors)"
              grep -nP '^\t' HomeCooked/HomeCooked.xcodeproj/project.pbxproj | head -5
            fi

            # Check for common corruption patterns
            echo ""
            echo "=== Checking for corruption patterns ==="
            if grep -q $'\r' HomeCooked/HomeCooked.xcodeproj/project.pbxproj; then
              echo "⚠️  WARNING: Found Windows line endings (CRLF)"
            else
              echo "✓ Unix line endings (LF)"
            fi

            # Check for valid UTF-8
            if file HomeCooked/HomeCooked.xcodeproj/project.pbxproj | grep -q "UTF-8"; then
              echo "✓ Valid UTF-8 encoding"
            else
              echo "⚠️  WARNING: Unexpected encoding"
              file HomeCooked/HomeCooked.xcodeproj/project.pbxproj
            fi

            # Verify braces are balanced
            OPEN_BRACES=$(grep -o '{' HomeCooked/HomeCooked.xcodeproj/project.pbxproj | wc -l)
            CLOSE_BRACES=$(grep -o '}' HomeCooked/HomeCooked.xcodeproj/project.pbxproj | wc -l)
            echo ""
            echo "=== Brace balance check ==="
            echo "Opening braces: $OPEN_BRACES"
            echo "Closing braces: $CLOSE_BRACES"
            if [ "$OPEN_BRACES" -eq "$CLOSE_BRACES" ]; then
              echo "✓ Braces are balanced"
            else
              echo "⚠️  WARNING: Unbalanced braces (diff: $((OPEN_BRACES - CLOSE_BRACES)))"
            fi

            echo ""
            echo "=== Project file structure ==="
            head -10 HomeCooked/HomeCooked.xcodeproj/project.pbxproj
            echo "..."
            tail -10 HomeCooked/HomeCooked.xcodeproj/project.pbxproj
          } 2>&1 | tee ci-logs/validate-project.log

      - name: Show available destinations
        run: xcodebuild -showdestinations -scheme HomeCooked -project HomeCooked/HomeCooked.xcodeproj || echo "Project not yet created"

      - name: Cache derived data
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('**/Package.resolved', '**/*.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Build project
        run: |
          set -o pipefail
          cd HomeCooked
          xcodebuild build \
            -scheme HomeCooked \
            -project HomeCooked.xcodeproj \
            -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR_DEVICE }},OS=${{ env.IOS_SIMULATOR_OS }}' \
            -configuration Debug \
            -derivedDataPath DerivedData \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee ../ci-logs/build.log

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ci-logs/*.log
          retention-days: 7
          if-no-files-found: ignore

  test:
    name: Test
    runs-on: macos-14
    timeout-minutes: 30
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create log directory
        run: mkdir -p ci-logs

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Cache derived data
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('**/Package.resolved', '**/*.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Run unit tests
        run: |
          set -o pipefail
          cd HomeCooked
          xcodebuild test \
            -scheme HomeCooked \
            -project HomeCooked.xcodeproj \
            -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR_DEVICE }},OS=${{ env.IOS_SIMULATOR_OS }}' \
            -configuration Debug \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee ../ci-logs/test.log

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            HomeCooked/DerivedData/Logs/Test/*.xcresult
            HomeCooked/DerivedData/Logs/Test/*.log
          retention-days: 7

      - name: Upload snapshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-snapshots
          path: |
            HomeCooked/Tests/**/__Snapshots__/**/*.png
            HomeCooked/Tests/**/__FailureDiffs__/**/*.png
          retention-days: 14

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: ci-logs/*.log
          retention-days: 7
          if-no-files-found: ignore

  lint:
    name: Lint
    runs-on: macos-14
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create log directory
        run: mkdir -p ci-logs

      - name: Install SwiftLint
        run: |
          brew install swiftlint

      - name: Install SwiftFormat
        run: |
          brew install swiftformat

      - name: Run SwiftFormat (check mode)
        continue-on-error: true
        run: |
          set -o pipefail
          cd HomeCooked
          swiftformat --config Tooling/swiftformat.yml --lint . \
            2>&1 | tee ../ci-logs/swiftformat.log

      - name: Run SwiftLint (strict)
        continue-on-error: true
        run: |
          set -o pipefail
          cd HomeCooked
          swiftlint lint \
            --config Tooling/swiftlint.yml \
            --strict \
            --reporter github-actions-logging \
            2>&1 | tee ../ci-logs/swiftlint.log

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            swiftlint-results.json
            swiftformat-results.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload lint logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: ci-logs/*.log
          retention-days: 7
          if-no-files-found: ignore

  ci_feedback:
    name: CI Feedback
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Download build logs
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: build-logs
          path: artifacts/build-logs

      - name: Download test logs
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-logs
          path: artifacts/test-logs

      - name: Download lint logs
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lint-logs
          path: artifacts/lint-logs

      - name: Generate CI feedback
        id: feedback_script
        continue-on-error: true
        env:
          BUILD_RESULT: ${{ needs.build.result }}
          TEST_RESULT: ${{ needs.test.result }}
          LINT_RESULT: ${{ needs.lint.result }}
        run: |
          python3 scripts/ci_feedback.py \
            artifacts \
            .ci \
            "${{ github.run_id }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "${{ github.sha }}" \
            "${{ github.head_ref || github.ref_name }}" \
            "${{ github.event.pull_request.number || 'none' }}"

      - name: Fallback feedback generation
        if: always() && steps.feedback_script.outcome != 'success'
        run: |
          mkdir -p .ci

          # Determine overall conclusion
          OVERALL="unknown"
          if [[ "${{ needs.build.result }}" == "failure" ]] || [[ "${{ needs.test.result }}" == "failure" ]] || [[ "${{ needs.lint.result }}" == "failure" ]]; then
            OVERALL="failure"
          elif [[ "${{ needs.build.result }}" == "success" ]] && [[ "${{ needs.test.result }}" == "success" ]] && [[ "${{ needs.lint.result }}" == "success" ]]; then
            OVERALL="success"
          fi

          # Generate minimal JSON summary
          cat > .ci/summary.json <<EOF
          {
            "run_id": "${{ github.run_id }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "sha": "${{ github.sha }}",
            "branch": "${{ github.head_ref || github.ref_name }}",
            "pr_number": ${{ github.event.pull_request.number || 'null' }},
            "overall_conclusion": "${OVERALL}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "jobs": [
              {"job_name": "build", "conclusion": "${{ needs.build.result }}", "failed_steps": []},
              {"job_name": "test", "conclusion": "${{ needs.test.result }}", "failed_steps": []},
              {"job_name": "lint", "conclusion": "${{ needs.lint.result }}", "failed_steps": []}
            ],
            "artifacts": [],
            "error": "Primary feedback script failed; this is a fallback summary"
          }
          EOF

          # Generate minimal markdown summary
          ICON="⚠️"
          if [[ "${OVERALL}" == "success" ]]; then
            ICON="✅"
          elif [[ "${OVERALL}" == "failure" ]]; then
            ICON="❌"
          fi

          cat > .ci/summary.md <<EOF
          # ${ICON} CI Feedback (Fallback)

          **Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Commit**: \`${{ github.sha }}\`
          **Branch**: \`${{ github.head_ref || github.ref_name }}\`
          ${{ github.event.pull_request.number && format('**PR**: #{0}', github.event.pull_request.number) || '' }}

          ## Job Results

          - Build: ${{ needs.build.result }}
          - Test: ${{ needs.test.result }}
          - Lint: ${{ needs.lint.result }}

          ⚠️ The primary feedback script failed. This is a minimal fallback summary.
          Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed logs.

          ---
          <!-- ci-feedback -->
          EOF

          echo "✓ Generated fallback feedback"

      - name: Commit feedback to branch
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git add .ci/summary.json .ci/summary.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ci: update CI feedback [skip ci]"
            git push origin HEAD:${{ github.head_ref || github.ref_name }}
          fi

      - name: Post or update PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summaryMd = fs.readFileSync('.ci/summary.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- ci-feedback -->')
            );

            const commentBody = summaryMd;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
              console.log('Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
              console.log('Created new PR comment');
            }

  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()

    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ Build failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "❌ Tests failed"
            exit 1
          fi
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "❌ Lint failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"
