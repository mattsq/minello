name: CI

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SWIFT_VERSION: '5.10'

jobs:
  # Linux stage - runs first
  linux:
    name: Linux Build & Test
    runs-on: ubuntu-latest
    container:
      image: swift:5.10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build tools
        run: apt-get update && apt-get install -y make pkg-config wget unzip

      - name: Build SQLite with SQLITE_ENABLE_SNAPSHOT
        run: |
          cd /tmp
          wget -q https://www.sqlite.org/2024/sqlite-autoconf-3470200.tar.gz
          tar xzf sqlite-autoconf-3470200.tar.gz
          cd sqlite-autoconf-3470200
          CFLAGS="-DSQLITE_ENABLE_SNAPSHOT=1 -O2" ./configure --prefix=/usr/local
          make -j$(nproc)
          make install
          ldconfig
          # Verify snapshot support is enabled
          sqlite3 --version
          echo "Checking for snapshot support..."
          sqlite3 :memory: "PRAGMA compile_options;" | grep -i snapshot || echo "Warning: SNAPSHOT not found in compile options"
          # Verify pkg-config can find our custom SQLite
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH}
          echo "PKG_CONFIG_PATH=${PKG_CONFIG_PATH}"
          pkg-config --modversion sqlite3 || echo "pkg-config cannot find sqlite3"
          pkg-config --cflags --libs sqlite3 || true
          # Verify the library has the required symbols
          nm -D /usr/local/lib/libsqlite3.so | grep -E 'sqlite3_sql|sqlite3_snapshot_open' || echo "Warning: symbols not found"

      - name: Display Swift version
        run: swift --version

      - name: Run preflight checks
        run: |
          chmod +x scripts/preflight.sh
          make preflight
        continue-on-error: false
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib

      - name: Build Swift packages
        run: swift build
        continue-on-error: false
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib

      - name: Run tests (parallel)
        id: test
        run: |
          swift test --parallel 2>&1 | tee /tmp/test-output.log
          exit ${PIPESTATUS[0]}
        continue-on-error: false
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-test-logs
          path: |
            /tmp/test-output.log
            /tmp/preflight_build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test fixtures (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-test-fixtures
          path: |
            Tests/Fixtures/**/*.json
            /tmp/*.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Failure summary
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✗ Linux CI failed - check logs above for details"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 1

  # macOS stage - runs after Linux succeeds
  macos:
    name: macOS Build & Test
    runs-on: macos-14
    needs: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer || \
          echo "Warning: Could not find Xcode 16.x, using default"
          xcodebuild -version

      - name: Display Swift version
        run: swift --version

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('Package.swift', 'App/**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Cache SwiftPM packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Run preflight checks
        run: |
          chmod +x scripts/preflight.sh
          make preflight
        continue-on-error: false

      - name: Install xcpretty (optional)
        run: |
          if ! command -v xcpretty &> /dev/null; then
            echo "Installing xcpretty for better output formatting..."
            gem install xcpretty || echo "Failed to install xcpretty, continuing without it"
          fi

      - name: Build iOS app
        id: build
        run: |
          set -o pipefail
          if command -v xcpretty &> /dev/null; then
            xcodebuild -scheme HomeCooked \
              -destination 'platform=iOS Simulator,name=iPhone 15' \
              -derivedDataPath ~/Library/Developer/Xcode/DerivedData/HomeCooked \
              build 2>&1 | tee /tmp/xcodebuild-build.log | xcpretty
          else
            xcodebuild -scheme HomeCooked \
              -destination 'platform=iOS Simulator,name=iPhone 15' \
              -derivedDataPath ~/Library/Developer/Xcode/DerivedData/HomeCooked \
              build 2>&1 | tee /tmp/xcodebuild-build.log
          fi
        continue-on-error: false

      - name: Run tests
        id: test
        run: |
          set -o pipefail
          if command -v xcpretty &> /dev/null; then
            xcodebuild -scheme HomeCooked \
              -destination 'platform=iOS Simulator,name=iPhone 15' \
              -derivedDataPath ~/Library/Developer/Xcode/DerivedData/HomeCooked \
              test 2>&1 | tee /tmp/xcodebuild-test.log | xcpretty
          else
            xcodebuild -scheme HomeCooked \
              -destination 'platform=iOS Simulator,name=iPhone 15' \
              -derivedDataPath ~/Library/Developer/Xcode/DerivedData/HomeCooked \
              test 2>&1 | tee /tmp/xcodebuild-test.log
          fi
        continue-on-error: false

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-logs
          path: |
            /tmp/xcodebuild-build.log
            /tmp/xcodebuild-test.log
            /tmp/preflight*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: |
            ~/Library/Developer/Xcode/DerivedData/HomeCooked/Logs/Test/*.xcresult
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-failures
          path: |
            ~/Library/Developer/Xcode/DerivedData/HomeCooked/Logs/Test/Attachments/**/*.png
            ~/Library/Developer/Xcode/DerivedData/HomeCooked/Logs/Test/Attachments/**/*.jpg
          retention-days: 14
          if-no-files-found: ignore

      - name: Failure summary
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✗ macOS CI failed - check logs and screenshots above"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 1
